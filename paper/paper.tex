%!TEX program = lualatex
\documentclass[a4paper, 11pt]{scrartcl}

\usepackage{csquotes}
%%\usepackage[french]{babel}
%%\usepackage[ngerman]{babel}


%% Choose default font for the document
%% Warning : only ONE of the following should be enabled
\usepackage{kpfonts}
%%\usepackage{libertine}

%% The following chose the default language for the document and
%% use the default typography rules for the choosen language.
\usepackage{polyglossia}
\setdefaultlanguage{english}
%% \setdefaultlanguage{german}
%%\setdefaultlanguage{french}

\usepackage[backend=biber, style=ieee]{biblatex}
\addbibresource{paper.bib}

\usepackage{graphicx}


%% to cite use \cite{Jerald:2015:VBH:2792790}
\begin{document}
\title{The DAO Hack}
\date{\today}   %% or \date{01 november 2018}
\author{
  Ramon Boss (\texttt{ramon.boss@students.bfh.ch}) \\
  Julian Stampfli (\texttt{julianjimmy.stampfli@students.bfh.ch})
}

\maketitle

\paragraph{Abstract}

In this paper we will explain what the DAO is, what happened to it and how the DAO could be exploited.
We will give an overview of the security bug and on the fallout that followed.

\setcounter{tocdepth}{2}
\tableofcontents
\clearpage

\section{Introduction}

To properly understand what has happened, first one needs to have a proper foundation on which to build upon.
This first section will be composed of those foundations.
If you can't be bothered by this you can skip directly to the next section.

\subsection{Blockchain}

The blockchain is a sequence of interlocked blocks of data.
Those block essentially contain the link to a parent block and an enumeration of transactions.
They are generated by the ethereum network and as such, nobody is in control of the blockchain itself.
Decisions have to be made by the majority of the network or else the network would split into two different sub-chains. \cite{blockchainKai}

A benefit of the blockchain is that no single party can change past transactions.
Thus, once something is in the blockchain, it is very hard to get rid of it. \cite{blockchainKai}

\subsubsection{Split / Hard Fork}

The Blockchain can be split at all times.
Meaning everybody can take the chain and create a new block for any older parent block.
Mostly smaller splits are simply ignored because they are non-consequential.
However, when a larger part of the network decides that they want to change something, they could take the blockchain as it was at any point in time and create a new chain which has its own history and its own cryptocurrency. \cite{blockchainKai}

\subsubsection{Smart Contract / Transaction}

In the traditional sense a money transaction states who pays whom how much.
The transactions in the blockchain can do just that, but mostly they have more functionality.
For instance, to verify that the sender actually is who he says needs to append a signature to the transaction.
Without this anybody could post transactions in the name of others.
This signature has to be verified by all the nodes because invalid transactions should never end up in the blockchain. \cite{blockchainKai}

This is the simplest form of a smart contract.
In comparison to a traditional transaction it contains of logic in addition to the data.
This logic is implemented with a simple scripting language for most blockchains. \cite{blockchainKai}

The validation of a signature is not the only use case for smart contracts.
A transaction could be bound to an arbitrary amount of rules that can be represented by the scripting language. \cite{blockchainKai}

\subsection{Ethereum}

Ethereum is one type of cryptocurrency.
The cash is calles ether.
Its main difference to others like Bitcoin is that it can run a complex programming language called Solidity.
With Solidity, you can create loops, functions and recursion which then are run on the ethereum blockchain.
This has huge advantages as one can create powerful smart contracts and bind the payment to those.
Only with such a powerful language the DAO could be created. \cite{eth}

\subsection{Investment Fund}

An investment fund is used to invest money. A investor can give money to a fond which will in turn invest the money by buying shares and other investment opportunities. Usually a fond will have a big diversification between their investments, often bigger than any single entity could achieve. A fond usually has some guidlines on how to invest the money based on risk and other factors. Those factors mostly differ a lot between fonds. As an example there are fonds that focus on the swiss market, or on the telecomunication market world wide.

The fond usually has someone in charge of the investments called fonds manager. He has the power to invest the money. Additionally to shares fonds also invest in proposals. A proposal is generated by companies where they offer investment opportunities for a specific project or program. The fond manager then bids on the proposals he thinks will be profitable.

The fonds manager also generates a report about how well the fond did. Based on that shares of the fond can be sold at a profit. 

\subsection{The DAO}

The DAO is an open source software written in Solidity build on the ethereum blockchain.

The DAO is like an investment fund running without any hierarchical management.
Investors (ethereum addresses) can exchange ether for DAO tokens (the DAOs currency) in a phase called initial phase. In the initial phase some starting properties are defined for the DAO like minimum ether required to successfully fund the DAO. It's like a kickstarter campaign, where people have to invest money to fund a project.

In the DAO there is no fund manager, instead each investor has a voting right based on the amount of tokens he holds. This is comparable to share holder meetings of a company. There the company invites all the investors (share holders) and they can vote with their shares. This is very impractical in the physical world as it is very hard to get all the investors together to vote for proposals. 

In the DAO this is way easier. As everything is digital votes can be held with large enough time frames and every investor can vote with a signed message on the blockchain. This way every proposal can be voted on by all the investors and they can directly influence where their money will be invested. 

A proposal can be created by any investor. It contains recipient of the investment, the amount of ether, the voting deadlines and other properties. For a proposal to be accepted it needs to have a given amount of Yes votes, it is executed, which means that the ether is sent to the recipient. To create a proposal the investor has to pay a fee, which will be refunded if it is accepted. 

To prevent malicious proposals there is an entity called curator. He can decline proposals before they go to a vote. This is necessary if a investor with a lot of voting power (>50\%) should create a proposal to send all the funds to his address. This curator is defined in the initial phase.

This curator obviously goes against the non-hierarchical management rule but he is necessary to protect against malicious proposals. Any investor can split off the main DAO into a new Sub DAO with a new curator. This split is a proposal as well which the curator can't block. After the voting period, which is smaller than the normal voting period, all investors who voted yes can split off the old DAO and join the new one. This way all investors are protected, even those who have a minority.

\section{What happened?}

In May 2016 when the DAO was launched on the ethereum blockchain it was funded with 12.7M ether.
As one ether was worth about 10-12 Dollars at that time, this corresponds to about 150 million dollars.

Soon after, on June 18, 2016, an unknown party was able to drain the funds of the DAO by exploiting a security bug that was present in the function that is used to withdraw the ether.
He was able to retrieve 3.5M ether which at that times would have been around 45 million dollars.

\subsection{How was that possible?}

The DAO includes the already mentioned functionality to split the DAO.
This was intended for people who either want to retrieve their funds or who weren't happy with the decisions of the DAO and wanted to invest differently.
Everybody could split the DAO at any time with a one-week waiting period.

The split function contains a function called withdrawRewardFor which calls rewardAccount.payOut which in turn calls \textunderscore recipient.call.value. The first two functions are defined in the DAO code and as such can't be changed at will. The call to recipient however is in the attackers hands. He can do there whatever he desires. In code this looks like that: \cite{deconstructingDaoAttack}

\begin{verbatim}
  function withdrawRewardFor(address _account) noEther 
    internal returns (bool _success) {
        if ((balanceOf(_account) * rewardAccount.accumulatedInput()) /
          totalSupply < paidOut[_account])
            throw;

        uint reward =
            (balanceOf(_account) * rewardAccount.accumulatedInput()) /
              totalSupply - paidOut[_account];
        if (!rewardAccount.payOut(_account, reward))
            throw;
        paidOut[_account] += reward;
        return true;
    }

    function payOut(address _recipient, uint _amount) returns (bool) {
        if (msg.sender != owner || msg.value > 0 ||
          (payOwnerOnly && _recipient != owner))
            throw;
        if (_recipient.call.value(_amount)()) {
            PayOut(_recipient, _amount);
            return true;
        } else {
            return false;
        }
    }
\end{verbatim}

One remark to this, some days before the attack there was a security fix proposed to the DAO master on Github, but wasn't committed immediately. With this fix the attack would not have been possible in this form. \cite{securityFixPayout}

Event though this had flaws, it alone wouldn't have been enough for this particular exploit. One more glaring flaw is in the splitDAO function itself: \cite{deconstructingDaoAttack}

\begin{verbatim}
        // Burn DAO Tokens
        Transfer(msg.sender, 0, balances[msg.sender]);
        withdrawRewardFor(msg.sender); // be nice, and get his rewards
        totalSupply -= balances[msg.sender];
        balances[msg.sender] = 0;
        paidOut[msg.sender] = 0;
        return true;
\end{verbatim}

As you can see from this snippet which comes from the splitDAO function, the withdrawRewardFor function gets called and then the balance of the sender gets set to 0. This way, if someone can call splitDAO recursively, withdrawRewardFor will get called multiple times with the same arguments. With this anybody could basically retrieve the whole investment by recursively calling splitDAO. However, it is important to note that if the call stack gets to big, it might fail due to a stack overflow or other issues. Thus, one attacker can only retrieve a limited amount of ether. The call stack would look something like this: \cite{deconstructingDaoAttack}

\begin{verbatim}
splitDAO:
  withdrawRewardFor:
    rewardAccount.payOut:
      _recipient.call.value:
        splitDAO:
          withdrawRewardFor:
            rewardAccount.payOut:
              _recipient.call.value:
                ...  
                  splitDAO:
                    withdrawRewardFor:
                      rewardAccount.payOut:
                        _recipient.call.value
\end{verbatim}

After the attacker exploited this he had a child DAO with more funds than it should have and a parent DAO which doesn't suspect that anything went wrong. To make things even worse, he was able to send back tokens to restart the attack. Only this way he was able to get this many ether out of it. \cite{deconstructingDaoAttack}

\section{What was the fallout?}



\section{Conclusion}

\nocite{*}
\clearpage
%% Print the bibibliography and add the section to the table of content
\printbibliography[heading=bibintoc]

\end{document}
